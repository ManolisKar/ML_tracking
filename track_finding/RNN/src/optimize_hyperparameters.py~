import os,sys
import numpy as np
import matplotlib
import matplotlib.pyplot as plt
import time

import seeding
import util
import clusterer
import detector
import seed_merging
import keras

tracker=detector.build_tracker()

## Read in synthetic events
import pickle
synthetic_dir='/Users/ekargian/Library/Mobile Documents/com~apple~CloudDocs/Documents/g-2/Trackers/ML_tracking/synthetic_data/pkl/'
rnn_dir='/Users/ekargian/Library/Mobile Documents/com~apple~CloudDocs/Documents/g-2/Trackers/ML_tracking/track_finding/RNN'
events_file=open(synthetic_dir+'synthetic_events.pkl','rb')
evts_hits,evts_ids = pickle.load(events_file,encoding='latin1')
if 'synthetic' in synthetic_dir:
    print('\n Reading in %d synthetic events' % evts_hits.shape[0])

    
### Build the NN
tracker_NN=clusterer.Clusterer(detector=tracker,
                               hidden_dim=120,
                               batch_size=100, 
                               n_epochs=12, val_frac=0.1)

tracker_NN.build_model(model_structure='LSTMx2_Dropout')
for seed_location in ['front','middle','back']:
    tracker_NN.model[seed_location].summary()

### Train
'''
from sklearn.model_selection import train_test_split
evts_hits_train, evts_hits_valid, evts_ids_train, evts_ids_valid = train_test_split(evts_hits,evts_ids, train_size=0.8)
tracker_NN.fit(evts_hits_train, evts_ids_train)
util.draw_train_history(tracker_NN.history)
'''
### We can choose to save the model after fitting
'''
for seed_location in ['front','middle','back']:
    tracker_NN.model[seed_location].save(rnn_dir+'/saved_models/tracker_NN_%s_2112_multiseed.h5'%seed_location) 
'''

### Or just read an existing model (must have same model structure)
for seed_location in ['front','middle','back']:
    tracker_NN.model[seed_location] = keras.models.load_model(rnn_dir+'/saved_models/tracker_NN_%s_2112_multiseed.h5'%seed_location)
    tracker_NN.model[seed_location].summary()

### Get accuracy metrics
## read in the 2-track synthetic events for scoring
events_file=open(synthetic_dir+'synthetic_events.pkl','rb')
evts_hits_2track,evts_ids_2track = pickle.load(events_file,encoding='latin1')
evts_hits_test=evts_hits_2track[:1000]
evts_ids_test=evts_ids_2track[:1000]

## First the raw selection score
util.raw_score(tracker_NN,evts_hits_test,evts_ids_test)

## Then score for accuracy/error after seed merging
start_time = time.time()
predicted_ids=seed_merging.predict_events(tracker_NN, evts_hits_test)#,verbose=1)
util.score_function(evts_ids_test, predicted_ids )
end_time = time.time()
print('time: ', end_time - start_time)
n_tracks=0
for predicted_id in predicted_ids:
    n_tracks += np.max(predicted_id)
print('Total tracks found: ', n_tracks)
