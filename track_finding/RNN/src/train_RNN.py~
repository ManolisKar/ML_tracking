import os,sys
import numpy as np
import matplotlib
import matplotlib.pyplot as plt
import time

import seeding
import util
from clusterer import Clusterer
import detector
import seed_merging


### Build the detector
tracker=detector.Detector()
tracker.make_straws()
print ('Straw x/y locations :: \n', tracker.x, '\n', tracker.y)
#util.display_event(tracker)


## Read in synthetic events
import pickle
synthetic_dir='/Users/ekargian/Library/Mobile Documents/com~apple~CloudDocs/Documents/g-2/Trackers/ML_tracking/synthetic_data/pkl/'
events_file=open(synthetic_dir+'synthetic_events.pkl','rb')
evts_hits,evts_ids = pickle.load(events_file,encoding='latin1')
if 'synthetic' in synthetic_dir:
    print('\n Reading in %d synthetic events' % evts_hits.shape[0])

    
### Build the NN
tracker_NN=Clusterer(detector=tracker,
                     hidden_dim=120,
                     batch_size=100, 
                     n_epochs=12, val_frac=0.1)

### Train
from sklearn.model_selection import train_test_split
evts_hits_train, evts_hits_valid, evts_ids_train, evts_ids_valid = train_test_split(evts_hits,evts_ids, train_size=0.8)

tracker_NN.build_model(model_structure='LSTMx2_Dropout')
for seed_location in ['front','middle','back']:
    tracker_NN.model[seed_location].summary()

tracker_NN.fit(evts_hits_train, evts_ids_train)
util.draw_train_history(tracker_NN.history)
